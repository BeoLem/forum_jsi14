<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= page.title %></title>
    <%- include('../partials/components.ejs') %>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.4/marked.min.js"
      integrity="sha512-nwWBb9WFoP7Q0hkeTjUPmHkkYLnmYgYnZ8PvQVVL2XJ9RLCGuLqKe86bhmZ3CJXGU8F777uuPkDQTkZ2qAuyvA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>
  <body>
    <div class="interaction">
      <div class="toasts"></div>
      <%- include('../partials/sidebar.ejs') %>
      <div id="content">
        <div id="header">
          <img class="avatar" src="" alt="" />
          <span
            >Posted by
            <a class="username" href="/users/contentHeaderUsername"></a>
          </span>
          <span
            class="timestamp"
            data-bs-toggle="tooltip"
            data-bs-placement="bottom"
            title="Tooltip on bottom"
          ></span>
        </div>

        <div id="main">
          <h3 class="title"></h3>
          <div class="description"></div>
        </div>

        <div class="tools">
          <button
            class="editButton authorOnly"
            onclick="location.href = '/blogs/edit/<%= params.id %>'"
            onmouseover="this.style.cursor = 'pointer'"
          >
            <i class="fa-solid fa-pen-to-square"></i> Edit
          </button>
          <button
            class="deleteButton authorOnly"
            title="Delete this blog"
            onclick="deleteBlog()"
            onmouseover="this.style.cursor = 'pointer'"
          >
            <i class="fa-solid fa-trash-can"></i> Delete
          </button>
          <button
            class="commentButton"
            onmouseover="this.style.cursor = 'pointer'"
          >
            <i class="fa-solid fa-comments"></i> Comment
          </button>
        </div>
      </div>
    </div>
  </body>
  <script type="text/javascript">
    const id = "<%= blogId %>" || "<%= params.id %>";

    document.addEventListener("DOMContentLoaded", () => {
      jQuery(document).ready(async function ($) {
        showLoadingIcon();

        try {
          blogFetchData = await $.ajax({
            url: `/api/blogs/${id}`,
            method: "GET",
            accepts: "application/json",
            contentType: "application/json",
          });
        } catch (err) {
          console.log(err);
          document.querySelector("#content").style.display = "none";
          hideLoadingIcon();
          if (!err.responseJSON)
            return displayErrorToast("I couldn't connect to the server!");
          return displayErrorToast(err.responseJSON.message);
        }

        const blog = blogFetchData.data;

        console.log(blog);

        const postedDate = new Date(0);
        postedDate.setUTCSeconds(blog.timestamp.seconds);

        // Bootstrap Tooltip
        var timestampSpan = document.querySelector(
          "#content #header .timestamp"
        );
        timestampSpan.innerHTML = ElapsedTimeConverter(postedDate);
        timestampSpan.title = postedDate;

        $("[data-bs-toggle=tooltip]").tooltip();

        // Edit username
        var headerUsername = document.querySelector("#content #header span a");
        var authorName = "";

        try {
          authorFetchData = await $.ajax({
            url: `/api/users/${blog.author}`,
            method: "GET",
            accepts: "application/json",
            contentType: "application/json",
          });
        } catch (err) {
          console.log(err);
          hideLoadingIcon();
          if (!err.responseJSON)
            return displayErrorToast("I couldn't connect to the server!");
          return displayErrorToast(err.responseJSON.message);
          authorName = `Unknown`;
        }

        authorName = authorFetchData.user.username;
        headerUsername.innerText = authorName;
        headerUsername.href = headerUsername.href.replace(
          "contentHeaderUsername",
          blog.author
        );

        // Edit title
        document.querySelector("#main .title").innerHTML = blog.title;

        const maxDescriptionWidthContainer =
          document.querySelector("#main").clientWidth + "px";
        // Edit description
        document.querySelector("#main .description").innerHTML = marked.parse(
          blog.description
        );

        // Edit image css
        document.querySelectorAll("img").forEach((v) => {
          console.log(v);
          v.style.maxWidth = maxDescriptionWidthContainer;
        });

        // Edit avatar
        document.querySelector(
          "#content #header .avatar"
        ).src = `https://avatars.dicebear.com/api/initials/${authorName}.svg`;

        window.addEventListener("resize", () => {
          console.log(document.querySelector("#main").clientWidth + "px");
          document.querySelectorAll("img").forEach((v) => {
            console.log(v);
            v.style.maxWidth =
              document.querySelector("#main").clientWidth + "px";
          });
        });

        if (blog.author == "<%= locals.user.id %>") {
          document
            .querySelectorAll(".authorOnly")
            .forEach((v) => (v.style.display = "block"));
        }

        hideLoadingIcon();
      });
    });

    async function deleteBlog() {
      let confirmation = prompt(
        `Are you sure you want to delete this blog? If you want to continue, please enter "${id}" to continue`
      );

      if (!confirmation) return;
      else if (confirmation != id)
        return displayErrorToast("You provided the wrong ID!");
      try {
        deleteFetchData = await $.ajax({
          url: `/api/blogs/${id}`,
          method: "DELETE",
          accepts: "application/json",
          contentType: "application/json",
          headers: {
            authorization: '<%= cookies.accessToken || "" %>',
          },
        });
      } catch (err) {
        console.log(err);
        if (!err.responseJSON)
          return displayErrorToast("I couldn't connect to the server!");
        return displayErrorToast(err.responseJSON.message);
      }
      if (
        deleteFetchData.statusCode >= 200 &&
        deleteFetchData.statusCode < 300
      ) {
        displayNotiToast("Deleted the blog successfully");
        location.href = "/";
      } else {
        alertdisplayErrorToast(deleteFetchData.message);
      }
    }
  </script>
</html>

<style>
  #content #header {
    margin-bottom: 20px;
  }

  .tools {
    margin-bottom: 20px;
    display: flex;
  }

  .tools button {
    background-color: white;
    padding: 5px;
    border: none;
    margin-right: 5px;
  }

  .tools button:hover {
    background-color: #d3d3d3;
  }

  #main .title {
    margin-bottom: 20px;
    font-weight: bold;
  }

  #main .description {
    overflow-wrap: anywhere;
  }

  #content #header .avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
  }

  #content #header span a {
    text-decoration: none;
  }

  #content #header span a:hover {
    text-decoration: underline;
  }

  .authorOnly {
    display: none;
  }
</style>
