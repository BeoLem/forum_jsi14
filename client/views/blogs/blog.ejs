<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= page.title %></title>
    <%- include('../partials/components.ejs') %>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.4/marked.min.js"
      integrity="sha512-nwWBb9WFoP7Q0hkeTjUPmHkkYLnmYgYnZ8PvQVVL2XJ9RLCGuLqKe86bhmZ3CJXGU8F777uuPkDQTkZ2qAuyvA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>
  <body>
    <div class="interaction">
      <div class="toasts"></div>
      <%- include('../partials/sidebar.ejs') %>
      <div id="content">
        <div id="header" class="header">
          <img class="avatar" src="" alt="" />
          <span
            >Posted by
            <a class="username" href="/users/contentHeaderUsername"></a>
          </span>
          <span
            class="timestamp"
            data-bs-toggle="tooltip"
            data-bs-placement="bottom"
            title="Tooltip on bottom"
          ></span>
        </div>

        <div id="main">
          <h3 class="title"></h3>
          <div class="description"></div>
        </div>

        <div class="tools">
          <button
            class="editButton authorOnly"
            onclick="location.href = '/blogs/edit/<%= params.id %>'"
          >
            <i class="fa-solid fa-pen-to-square"></i> Edit
          </button>
          <button
            class="deleteButton authorOnly"
            title="Delete this blog"
            onclick="deleteBlog(this)"
          >
            <i class="fa-solid fa-trash-can"></i> Delete
          </button>
        </div>

        <div class="comments">
          <form id="commentHeader">
            <% if(!locals.user.id) { %>
            <span>
              <a class="username" href="/auth/login">Log in</a>
              to comment
            </span>
            <% } else { %>
            <span
              >Comment as
              <a class="username" href="/users/<%= locals.user.id %>"
                ><%= locals.user.username %></a
              >
            </span>
            <textarea
              name="textComment"
              id="textComment"
              placeholder="What are your thoughts?"
            ></textarea>
            <button class="commentButton toolButton" type="submit">
              <i class="fa-solid fa-comments"></i> Comment
            </button>
            <% } %>
          </form>

          <div class="list">
            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>

            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>

            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>

            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>

            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>

            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>

            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>

            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>

            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>

            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>

            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>

            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>

            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>

            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>

            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>

            <div class="comment">
              <div id="cmtHeader" class="header">
                <img
                  class="avatar"
                  src="https://avatars.dicebear.com/api/initials/blam.svg"
                  alt=""
                />
                <span>
                  <a class="username" href="/users/blam">blam</a>
                </span>
                <span
                  class="timestamp"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                  title="Tooltip on bottom"
                  >1 week ago</span
                >
              </div>

              <div class="main">
                <h3 class="text">
                  Wow! Thanks for your blog! I can spend the whole Christmas
                  visting this blog!
                </h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script type="text/javascript">
    const id = "<%= blogId %>" || "<%= params.id %>";

    document.addEventListener("DOMContentLoaded", () => {
      jQuery(document).ready(async function ($) {
        showLoadingIcon();

        try {
          blogFetchData = await $.ajax({
            url: `/api/blogs/${id}`,
            method: "GET",
            accepts: "application/json",
            contentType: "application/json",
          });
        } catch (err) {
          console.log(err);
          $("#content").css("display", "none");
          hideLoadingIcon();
          if (!err.responseJSON)
            return displayErrorToast("I couldn't connect to the server!");
          return displayErrorToast(err.responseJSON.message);
        }

        const blog = blogFetchData.data;

        if (!blog) {
          hideLoadingIcon();
          return displayErrorToast("I couldn't retrieve the blog information!");
        }

        console.log(blog);

        const postedDate = new Date(0);
        postedDate.setUTCSeconds(blog.timestamp.seconds);

        // Bootstrap Tooltip
        var timestampSpan = $("#content #header .timestamp");
        timestampSpan.html(ElapsedTimeConverter(postedDate));
        // timestampSpan.title = postedDate;

        $("[data-bs-toggle=tooltip]").tooltip();

        // Edit username
        var headerUsername = $("#content #header span a");
        var authorName = "";

        try {
          authorFetchData = await $.ajax({
            url: `/api/users/${blog.author}`,
            method: "GET",
            accepts: "application/json",
            contentType: "application/json",
          });
        } catch (err) {
          console.log(err);
          hideLoadingIcon();
          if (!err.responseJSON)
            return displayErrorToast("I couldn't connect to the server!");
          return displayErrorToast(err.responseJSON.message);
          authorName = `Unknown`;
        }

        authorName = authorFetchData.user.username;
        headerUsername.text(authorName);
        headerUsername.attr(
          "href",
          headerUsername
            .attr("href")
            .replace("contentHeaderUsername", blog.author)
        );

        // Edit title
        $("#main .title").html(blog.title);

        let maxDescriptionWidthContainer = $("#main").innerWidth() + "px";
        // Edit description
        $("#main .description").html(marked.parse(blog.description));

        // Edit image css
        let contentImgs = $("img");
        contentImgs.each((i) => {
          contentImgs[i].style.maxWidth = maxDescriptionWidthContainer;
        });

        // Edit avatar
        $("#content #header .avatar").attr(
          "src",
          `https://avatars.dicebear.com/api/initials/${authorName}.svg`
        );

        window.addEventListener("resize", () => {
          maxDescriptionWidthContainer = $("#main").innerWidth() + "px";
          contentImgs.each((i) => {
            contentImgs[i].style.maxWidth = maxDescriptionWidthContainer;
          });
        });

        if (blog.author == "<%= locals.user.id %>") {
          let authorOnlyTools = $(".authorOnly");

          authorOnlyTools.each(
            (v) => (authorOnlyTools[v].style.display = "block")
          );
        }

        hideLoadingIcon();

        // Comment Submit
        $("form#commentHeader").submit(() => {
          event.preventDefault();
          createComment($(".commentButton.toolButton"));
        });
      });
    });

    async function deleteBlog(button) {
      let confirmation = prompt(
        `Are you sure you want to delete this blog? If you want to continue, please enter "${id}" to continue`
      );

      if (!confirmation) return;
      else if (confirmation != id)
        return displayErrorToast("You provided the wrong ID!");

      button.setAttribute("disabled", "disabled");
      button.classList.toggle("disabled");
      button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              <span>Handling...</span>`;

      try {
        deleteFetchData = await $.ajax({
          url: `/api/blogs/${id}`,
          method: "DELETE",
          accepts: "application/json",
          contentType: "application/json",
          headers: {
            authorization: '<%= cookies.accessToken || "" %>',
          },
        });
      } catch (err) {
        console.log(err);
        button.removeAttribute("disabled");
        button.classList.toggle("disabled");
        button.innerHTML = `<i class="fa-solid fa-trash-can"></i> Delete`;
        if (!err.responseJSON)
          return displayErrorToast("I couldn't connect to the server!");
        return displayErrorToast(err.responseJSON.message);
      }
      if (
        deleteFetchData.statusCode >= 200 &&
        deleteFetchData.statusCode < 300
      ) {
        displayNotiToast("Deleted the blog successfully");
        location.href = "/";
      } else {
        alertdisplayErrorToast(deleteFetchData.message);
      }
    }

    async function createComment(button) {
      const textarea = $("textarea#textComment");
      if (!textarea)
        return displayErrorToast(
          "An error occured while loading the page! Please reload the page."
        );
      const value = textarea.val();
      if (!value || value == "")
        return displayErrorToast("Please fill in the description!");

      textarea.attr("disabled", "disabled");
      button.attr("disabled", "disabled");
      button.classList.toggle("disabled");
      button.html(`<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              <span>Handling...</span>`);

      let data;
      try {
        data = await $.ajax("/api/comments/", {
          method: "POST",
          accepts: "application/json",
          data: JSON.stringify({
            id,
            description: value,
          }),
          contentType: "application/json",
          headers: {
            authorization: "<%= cookies.accessToken %>",
          },
        });
      } catch (err) {
        textarea.removeAttr("disabled");
        button.removeAttr("disabled");
        button.classList.toggle("disabled");
        button.html(`<i class="fa-solid fa-comments"></i> Comment`);
        console.log(err);
        if (!err.responseJSON)
          return displayErrorToast("I couldn't connect to the server!");
        return displayErrorToast(err.responseJSON.message);
      }

      textarea.removeAttr("disabled");
      button.removeAttr("disabled");
      button.classList.toggle("disabled");
      button.html(`<i class="fa-solid fa-comments"></i> Comment`);
      textarea.val("");
      displayNotiToast("Comment posted!");
    }
  </script>
</html>

<style>
  :root {
    --commentTextArea-width: 500px;
  }

  #content #header {
    margin-bottom: 20px;
  }

  .tools {
    margin-bottom: 20px;
    display: flex;
    flex-direction: column;
  }

  .tools button,
  .toolButton {
    width: var(--commentTextArea-width);
    border: 1px solid #d3d3d3;
    padding: 10px;
    margin-bottom: 10px;
  }

  .tools button:not([disabled]):hover,
  .toolButton:not([disabled]):hover {
    background-color: #d3d3d3;
  }

  #main .title {
    margin-bottom: 20px;
    font-weight: bold;
  }

  #main .description {
    overflow-wrap: anywhere;
  }

  #content #header .avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
  }

  #content #header span a {
    text-decoration: none;
  }

  #content #header span a:hover {
    text-decoration: underline;
  }

  .authorOnly {
    display: none;
  }

  .comments #commentHeader #textComment {
    margin-top: 5px;
    resize: vertical;
    resize: none;
    width: var(--commentTextArea-width);
    height: 125px;
    padding: 10px;
    border: 1px solid #d3d3d3;
  }

  .comments #commentHeader {
    display: flex;
    flex-direction: column;
    padding-bottom: 25px;
    border-bottom: 1px solid #d3d3d3;
  }

  .commentButton {
    width: var(--commentTextArea-width);
    margin-top: 5px;
  }

  .list {
    margin-top: 25px;
  }

  .list .comment {
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 20px;
  }

  .list .comment .avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
  }

  .list .comment .header {
    margin-bottom: 20px;
  }

  .list .comment .header a {
    text-decoration: none;
  }

  .list .comment .header a:hover {
    text-decoration: underline;
  }

  .list .comment .text {
    font-size: 16px;
  }

  @media screen and (max-width: 1000px) {
    :root {
      --commentTextArea-width: 100%;
    }

    .tools button,
    .toolButton {
      padding: 30px;
      margin-bottom: 30px;
    }
  }
</style>
